## 数字货币钱包详解

「钱包」这个词语在以太坊中表示的并不是它本来的意思


宏观的讲，钱包主要就是为用户提供用户界面的一个应用。它掌管着用户的金钱，管理着密钥和地址，追踪账户余额以及创建交易和签名。除此之外，一些以太坊钱包还可以与智能合约进行交互，例如代币之类的。

而从一个程序员的角度更准确的讲，「钱包」这个词语指的就是存储和管理密钥和地址的系统。每一个「钱包」都有一个密钥管理组件。而对于有些钱包来说，这就是钱包的全部。其他的大部分钱包都是「浏览器」，其实就是基于以太坊的去中心化应用的接口。所以这些各式各样的「钱包」之间并没有什么明确的界限。

接下来让我们先看一看钱包关于密钥管理和私钥容器部分的功能。

### 钱包技术总览
在这个部分我们会总结用于构建用户友好、安全以及灵活的以太坊钱包所需要的各种技术。

关于以太坊有一个最常见的误解就是大部分人认为以太坊钱包包含以太坊和其他代币。而实际上，钱包只包含密钥。以太坊和其他代币都被记录在以太坊的区块链中。用户通过使用他们钱包中的密钥对钱包签名来控制代币。所以从某种意义上讲，以太坊钱包就是一个钥匙串。

     提示

     以太坊钱包只包含密钥，而没有以太坊和代币。每一个用户的钱包都包含密钥。钱包就是包含公私钥对的钥匙串。用户使用密钥对交易签名，
     以此来证明这些以太坊就是属于他们的。而真正的以太坊则存储在区块链上。

目前主要有两种类型的钱包，他们的区别就是所包含的密钥之间是否有关联。

第一种类型叫做非确定性钱包，它的每一个密钥都是通过一个随机数独立生成的。密钥之间相互没有关联。这种钱包也叫做 JBOK 钱包（来自 "Just a Bunch Of Keys"）。

第二种钱包叫做确定性钱包，它所有的密钥都来源于一个单独的叫做种子的主密钥。在这个钱包中所有的密钥都相互关联，并且任何拥有原始种子的人都可以将这些密钥再生成一遍。这种确定性钱包会使用很多不同的密钥派生方法。而其中使用最普遍的则是一种类似树形结构的方法，这样的钱包被称为分层确定性或者 HD 钱包。

分层确定性钱包是通过一个种子来初始化的。而为了便于使用，种子会被编码成英语单词（或者其他语言的单词），这些单词被称为助记词。
下面的章节将会在更高级的层面介绍这些技术。

### 非确定性（随机）钱包

在第一个的以太坊钱包（以太坊预售时发布的）中，钱包文件会存储一个单独随机生成的私钥。然而这种钱包之后被确定性钱包取代了，因为这种钱包无法管理、备份以及导入私钥。但是随机密钥的缺点是，如果你生成了很多那么你就要把它们全部拷贝下来。每一个密钥都要备份，否则一旦钱包丢失，那些密钥对应的资产也会丢失。进一步讲，以太坊地址的隐私性会因为相互之间关联的多笔交易和地址的重复使用而大大降低。一个类型-0 的非确定性钱包并不是一个好的选择，尤其是当你为了避免地址的重复使用而不得不管理多个密钥并不断频繁的备份它们时。

很多以太坊客户端（包括 go-ethereum 和 geth）都会使用一个钥匙串文件，这是一个 JSON 编码的文件，而且它还包含一个单独的（随机生成的）私钥，为了安全性，这个私钥会通过一个密码进行加密。这个 JSON 文件就像下面这样：

    {
    "address": "001d3f1ef827552ae1114027bd3ecf1f086ba0f9",
    "crypto": {
        "cipher": "aes-128-ctr",
        "ciphertext": "233a9f4d236ed0c13394b504b6da5df02587c8bf1ad8946f6f2b58f055507ece",
        "cipherparams": {
            "iv": "d10c6ec5bae81b6cb9144de81037fa15"
        },
        "kdf": "scrypt",
        "kdfparams": {
            "dklen": 32,
            "n": 262144,
            "p": 1,
            "r": 8,
            "salt": "99d37a47c7c9429c66976f643f386a61b78b97f3246adca89abe4245d2788407"
        },
        "mac": "594c8df1c8ee0ded8255a50caf07e8c12061fd859f4b7c76ab704b17c957e842"
    },
    "id": "4fcb2ba4-ccdb-424f-89d5-26cce304bf9c",
    "version": 3
    }

钥匙串格式使用的是Key Derivation Function (KDF)，同时还被成为密码拉伸算法，这个算法可以防止暴力破解、字典攻击以及彩虹表攻击。简单来说就是私钥并不是直接通过密码简单的进行加密的。相反，这个密码是通过不断的重复哈希拉伸过的。这个哈希函数会重复 262144 轮，这个数字就是钥匙串 JSON 文件中的 crypto.kdfparams.n 这个参数指定的。一个攻击者试图通过暴力破解的手段来破解密码的话，那么他需要为每一个可能的密码执行 262144 轮哈希，这样对于一个足够复杂和长度的密码来说被破解几乎是不可能的。


这里还有一些软件库可以读取和写入钥匙串格式，例如 JavaScript 的库 keythereum：

[github.com/ethereumjs/…](https://link.juejin.im/?target=https%3A%2F%2Fgithub.com%2Fethereumjs%2Fkeythereum)


     提示

     除了一些简单的测试之外，我们是不推荐使用非确定性钱包的。我们推荐使用的是拥有助记词种子备份功能的基于行业标准的HD 钱包。



### 确定性钱包（种子）钱包
确定性或者说「种子」钱包是指那些所有的私钥都是通过一个普通的种子使用一个单向哈希函数延伸而来的钱包。这个种子是结合一些其他的数据而随机生成的数字，例如利用一个索引数字或者「链码」（查看HD 钱包(BIP-32/BIP-44)来派生出私钥。在一个确定性钱包中，一个种子就足够恢复出所有派生的密钥，因此只需要在创建的时候做一次备份就可以了。同时，这个种子对于钱包来说也是可以导入导出的，可以让所有用户的密钥在各种不同的钱包之间进行简单的迁移。


### HD 钱包 (BIP-32/BIP-44)
确定性钱包的开发就是为了可以简单的从一个「种子」派生出很多个密钥。而这种确定性钱包最高级的实现就是由比特币的 BIP-32 标准定义的 HD 钱包。HD 钱包包含的密钥来源于一个树形的结构，例如一个父密钥可以派生出一系列子密钥，每一个子密钥又可以派生出一系列孙子密钥，不停的循环往复，没有尽头。这个树形结构的示意图如下：


![](https://i.imgur.com/3dRVUi5.png)


HD 钱包相对于随机的（非确定性的）密钥有两个主要的优势。一，树形结构可以表达额外的组织意义，例如当一个子密钥特定的分支用来接收转入支付而另一个不同的分支可以接收转出支付的改变。密钥的分支也可以在一些共同的设置中被使用，例如可以分配不同的分支给部门、子公司、特定的函数或者不同的账单类别。

第二个优势就是用户可以使用 HD 钱包在不利用相关私钥的情况下创建一系列公钥。这样 HD 钱包就可以用来做一个安全的服务或者是一个仅仅用来观察和接收的服务，而钱包本身却没有私钥，所以它也无法花费资金。
